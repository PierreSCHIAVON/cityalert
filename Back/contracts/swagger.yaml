openapi: 3.0.0
info:
  title: API Alertes Citoyennes
  version: 1.0.2
  description: >
    API permettant de remonter et gérer des alertes citoyennes, leurs catégories,
    leurs médias associés, les participations des citoyens, et la gestion des clés API.
    L'authentification est gérée par un autre service — aucune authentification JWT n'est requise ici.

servers:
  - url: http://localhost:3000
    description: Serveur de développement local

tags:
  - name: App
    description: Gestion des applications clientes (clé API & JWT)
  - name: Alertes
    description: Opérations liées aux alertes citoyennes
  - name: Catégories
    description: Gestion des catégories d'alerte
  - name: Médias
    description: Gestion des médias associés aux alertes
  - name: Participations
    description: Participations des citoyens aux alertes
  - name: API Keys
    description: Gestion des clés API pour les utilisateurs

paths:

  ############################
  # APP AUTH
  ############################

  /api/app/register:
    post:
      tags: [App]
      summary: Enregistre une nouvelle application cliente (clé API)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                password:
                  type: string
                  format: password
              required:
                - name
                - password
      responses:
        '201':
          description: Application créée avec succès
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/App'
        '500':
          description: Erreur serveur


  /api/app/login:
    post:
      tags: [App]
      summary: Authentifie une application et génère les tokens JWT
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                password:
                  type: string
                  format: password
              required:
                - name
                - password
      responses:
        '200':
          description: Connexion réussie
          content:
            application/json:
              schema:
                type: object
                properties:
                  app:
                    $ref: '#/components/schemas/App'
                  accessToken:
                    type: string
                  refreshToken:
                    type: string
        '400':
          description: Mot de passe incorrect
        '404':
          description: Application inconnue
        '500':
          description: Erreur serveur


  /api/app/info:
    get:
      tags: [App]
      summary: Récupère les informations de l'application authentifiée
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Informations récupérées
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/App'
        '404':
          description: Application inconnue
        '500':
          description: Erreur serveur


  /api/app/refresh-token:
    post:
      tags: [App]
      summary: Rafraîchit un access token expiré via un refresh token valide
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                token:
                  type: string
                  description: Refresh token JWT
              required:
                - token
      responses:
        '200':
          description: Nouveau token généré
          content:
            application/json:
              schema:
                type: object
                properties:
                  accessToken:
                    type: string
        '401':
          description: Refresh token manquant
        '403':
          description: Refresh token invalide ou expiré
        '500':
          description: Erreur serveur



  ############################
  # ALERTES
  ############################
  /api/alerts:
    get:
      tags: [Alertes]
      summary: Récupère la liste des alertes citoyennes
      responses:
        '200':
          description: Liste récupérée avec succès
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Alerte'
        '500':
          description: Erreur interne du serveur

    post:
      tags: [Alertes]
      summary: Crée une nouvelle alerte citoyenne
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AlerteInput'
      responses:
        '201':
          description: Alerte créée
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Alerte'
        '400':
          description: Données invalides


  /api/alerts/{id_alert}/{user_id}:
    get:
      tags: [Alertes]
      summary: Récupère une alerte par clé composite
      parameters:
        - name: id_alert
          in: path
          required: true
          schema:
            type: integer
        - name: user_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Alerte trouvée
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Alerte'
        '404':
          description: Alerte non trouvée

    put:
      tags: [Alertes]
      summary: Met à jour une alerte
      parameters:
        - name: id_alert
          in: path
          required: true
          schema:
            type: integer
        - name: user_id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AlerteInput'
      responses:
        '200':
          description: Alerte mise à jour
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Alerte'
        '404':
          description: Alerte non trouvée

    delete:
      tags: [Alertes]
      summary: Supprime une alerte
      parameters:
        - name: id_alert
          in: path
          required: true
          schema:
            type: integer
        - name: user_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '204':
          description: Alerte supprimée
        '404':
          description: Alerte non trouvée


  ############################
  # CATEGORIES
  ############################

  /api/categories:
    get:
      tags: [Catégories]
      summary: Récupère toutes les catégories
      responses:
        '200':
          description: Liste récupérée
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Categorie'

    post:
      tags: [Catégories]
      summary: Crée une catégorie
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CategorieInput'
      responses:
        '201':
          description: Catégorie créée
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Categorie'


  /api/categories/{id_category}:
    get:
      tags: [Catégories]
      summary: Récupère une catégorie
      parameters:
        - name: id_category
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Catégorie trouvée
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Categorie'
        '404':
          description: Catégorie non trouvée

    put:
      tags: [Catégories]
      summary: Met à jour une catégorie
      parameters:
        - name: id_category
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CategorieInput'
      responses:
        '200':
          description: Mise à jour effectuée
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Categorie'
        '404':
          description: Non trouvée

    delete:
      tags: [Catégories]
      summary: Supprime une catégorie
      parameters:
        - name: id_category
          in: path
          required: true
          schema:
            type: integer
      responses:
        '204':
          description: Supprimée
        '404':
          description: Non trouvée


  ############################
  # MEDIAS
  ############################

  /api/medias:
    get:
      tags: [Médias]
      summary: Récupère tous les médias
      responses:
        '200':
          description: Liste récupérée
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Media'

    post:
      tags: [Médias]
      summary: Ajoute un média via une URL pré-uploadée
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MediaInput'
      responses:
        '201':
          description: Média ajouté
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Media'


  /api/medias/{id_media}:
    get:
      tags: [Médias]
      summary: Récupère un média
      parameters:
        - name: id_media
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Média trouvé
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Media'
        '404':
          description: Non trouvé

    delete:
      tags: [Médias]
      summary: Supprime un média
      parameters:
        - name: id_media
          in: path
          required: true
          schema:
            type: integer
      responses:
        '204':
          description: Supprimé
        '404':
          description: Non trouvé


  ############################
  # PARTICIPATIONS
  ############################

  /api/participations:
    get:
      tags: [Participations]
      summary: Liste toutes les participations
      responses:
        '200':
          description: Liste récupérée
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Participation'

    post:
      tags: [Participations]
      summary: Crée une participation
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ParticipationInput'
      responses:
        '201':
          description: Participation créée
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Participation'


  /api/participations/{id_participation}:
    get:
      tags: [Participations]
      summary: Récupère une participation
      parameters:
        - name: id_participation
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Trouvée
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Participation'
        '404':
          description: Non trouvée

    delete:
      tags: [Participations]
      summary: Supprime une participation
      parameters:
        - name: id_participation
          in: path
          required: true
          schema:
            type: integer
      responses:
        '204':
          description: Participation supprimée
        '404':
          description: Participation non trouvée

  ############################
  # API KEYS
  ############################
  /api/api_keys:
    post:
      tags: [API Keys]
      summary: Crée une nouvelle clé API pour un utilisateur
      description: >
        Un utilisateur ne peut avoir qu'une seule clé API active.
        La clé brute (raw_key) est retournée uniquement lors de la création et ne pourra plus être récupérée par la suite.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ApiKeyInput'
      responses:
        '201':
          description: Clé API créée avec succès
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiKeyCreated'
        '400':
          description: Données invalides (user_id manquant)
        '409':
          description: L'utilisateur possède déjà une clé API
        '500':
          description: Erreur interne du serveur

  /api/api_keys/{user_id}:
    get:
      tags: [API Keys]
      summary: Récupère la clé API d'un utilisateur
      description: >
        Retourne les informations de la clé API (sans la clé brute).
        Retourne null si l'utilisateur n'a pas de clé.
      parameters:
        - name: user_id
          in: path
          required: true
          description: ID de l'utilisateur
          schema:
            type: integer
      responses:
        '200':
          description: Clé API trouvée ou null
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/ApiKey'
                  - type: object
                    nullable: true
        '500':
          description: Erreur interne du serveur
    delete:
      tags: [API Keys]
      summary: Supprime la clé API d'un utilisateur
      parameters:
        - name: user_id
          in: path
          required: true
          description: ID de l'utilisateur
          schema:
            type: integer
      responses:
        '200':
          description: Clé API supprimée avec succès
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: API key deleted.
        '404':
          description: Aucune clé API trouvée pour cet utilisateur
        '500':
          description: Erreur interne du serveur

components:

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:

    #######################
    # APP
    #######################
    App:
      type: object
      properties:
        id_api_key:
          type: integer
        user_id:
          type: integer
        key_hash:
          type: string
        name:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time
          nullable: true
        last_used_at:
          type: string
          format: date-time
          nullable: true
        expires_at:
          type: string
          format: date-time
          nullable: true
        is_active:
          type: boolean
          nullable: true
        refresh_token:
          type: string
          nullable: true
      required:
        - id_api_key
        - user_id
        - key_hash

    #######################
    # Alerte
    #######################
    Alerte:
      type: object
      properties:
        id_alert:
          type: integer
        user_id:
          type: integer
        title:
          type: string
        description:
          type: string
        status:
          type: string
          enum: [ouverte, en_cours, resolue]
        intensity:
          type: string
        created_at:
          type: string
          format: date-time
        location_lat:
          type: number
        location_lon:
          type: number
        id_category:
          type: integer
        category:
          $ref: '#/components/schemas/Categorie'
        media:
          type: array
          items:
            $ref: '#/components/schemas/Media'
        participation:
          type: array
          items:
            $ref: '#/components/schemas/Participation'
      required:
        - id_alert
        - user_id
        - title
        - description
        - status
        - intensity
        - created_at
        - location_lat
        - location_lon
        - id_category

    AlerteInput:
      type: object
      properties:
        user_id:
          type: integer
        title:
          type: string
        description:
          type: string
        status:
          type: string
          enum: [ouverte, en_cours, resolue]
        intensity:
          type: string
        location_lat:
          type: number
        location_lon:
          type: number
        id_category:
          type: integer
      required:
        - user_id
        - title
        - description
        - intensity
        - location_lat
        - location_lon
        - id_category

    #######################
    # Catégorie
    #######################
    Categorie:
      type: object
      properties:
        id_category:
          type: integer
        title:
          type: string
      required:
        - id_category
        - title

    CategorieInput:
      type: object
      properties:
        title:
          type: string
      required:
        - title

    #######################
    # Médias
    #######################
    Media:
      type: object
      properties:
        id_media:
          type: integer
        file_type:
          type: string
        file_url:
          type: string
        uploaded_at:
          type: string
          format: date-time
        id_alert:
          type: integer
        user_id:
          type: integer
      required:
        - id_media
        - file_url
        - id_alert
        - user_id

    MediaInput:
      type: object
      properties:
        file_url:
          type: string
        file_type:
          type: string
        id_alert:
          type: integer
        user_id:
          type: integer
      required:
        - file_url
        - file_type
        - id_alert
        - user_id

    #######################
    # Participation
    #######################
    Participation:
      type: object
      properties:
        id_participation:
          type: integer
        user_id:
          type: integer
        response:
          type: string
        date_response:
          type: string
          format: date-time
        id_alert:
          type: integer
        alert_user_id:
          type: integer
      required:
        - id_participation
        - user_id
        - date_response
        - id_alert
        - alert_user_id

    ParticipationInput:
      type: object
      properties:
        user_id:
          type: integer
        response:
          type: string
        id_alert:
          type: integer
        alert_user_id:
          type: integer
      required:
        - user_id
        - id_alert
        - alert_user_id

    #######################
    # API Key
    #######################
    ApiKey:
      type: object
      properties:
        id_api_key:
          type: integer
          description: Identifiant unique de la clé API
        user_id:
          type: integer
          description: Identifiant de l'utilisateur propriétaire de la clé
        name:
          type: string
          nullable: true
          maxLength: 100
          description: Nom optionnel pour identifier la clé
        created_at:
          type: string
          format: date-time
          description: Date et heure de création de la clé
        last_used_at:
          type: string
          format: date-time
          nullable: true
          description: Date et heure de dernière utilisation
        expires_at:
          type: string
          format: date-time
          nullable: true
          description: Date et heure d'expiration de la clé
        is_active:
          type: boolean
          description: Indique si la clé est active
      required:
        - id_api_key
        - user_id
        - created_at
        - is_active

    ApiKeyInput:
      type: object
      properties:
        user_id:
          type: integer
          description: Identifiant de l'utilisateur pour lequel créer la clé API
        name:
          type: string
          maxLength: 100
          description: Nom optionnel pour identifier la clé
      required:
        - user_id

    ApiKeyCreated:
      type: object
      properties:
        message:
          type: string
          example: API Key created.
        api_key:
          type: object
          properties:
            raw_key:
              type: string
              description: >
                Clé API brute (en clair). Cette valeur ne sera plus accessible après cette réponse.
                Le client doit la sauvegarder de manière sécurisée.
              example: "a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6"
            id_api_key:
              type: integer
              description: Identifiant unique de la clé API
            user_id:
              type: integer
              description: Identifiant de l'utilisateur
            name:
              type: string
              nullable: true
              description: Nom de la clé
            created_at:
              type: string
              format: date-time
              description: Date de création
            is_active:
              type: boolean
              description: Statut actif de la clé
      required:
        - message
        - api_key