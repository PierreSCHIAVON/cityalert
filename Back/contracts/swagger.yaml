openapi: 3.0.0
info:
  title: API Alertes Citoyennes
  version: 1.0.1
  description: >
    API permettant de remonter et gérer des alertes citoyennes, leurs catégories,
    leurs médias associés, et les participations des citoyens.
    L'authentification des applications clientes est gérée via le module /api/app.

servers:
  - url: http://localhost:3000
    description: Serveur de développement local

tags:
  - name: App
    description: Gestion des applications clientes (clé API & JWT)
  - name: Alertes
    description: Opérations liées aux alertes citoyennes
  - name: Catégories
    description: Gestion des catégories d'alerte
  - name: Médias
    description: Gestion des médias associés aux alertes
  - name: Participations
    description: Participations des citoyens aux alertes

paths:
  ############################
  # APP AUTH
  ############################

  /api/app/register:
    post:
      tags: [App]
      summary: Enregistre une nouvelle application cliente (clé API)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                password:
                  type: string
                  format: password
              required:
                - name
                - password
      responses:
        "201":
          description: Application créée avec succès
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/App"
        "500":
          description: Erreur serveur

  /api/app/login:
    post:
      tags: [App]
      summary: Authentifie une application et génère les tokens JWT
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                password:
                  type: string
                  format: password
              required:
                - name
                - password
      responses:
        "200":
          description: Connexion réussie
          content:
            application/json:
              schema:
                type: object
                properties:
                  app:
                    $ref: "#/components/schemas/App"
                  accessToken:
                    type: string
                  refreshToken:
                    type: string
        "400":
          description: Mot de passe incorrect
        "404":
          description: Application inconnue
        "500":
          description: Erreur serveur

  /api/app/info:
    get:
      tags: [App]
      summary: Récupère les informations de l'application authentifiée
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Informations récupérées
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/App"
        "404":
          description: Application inconnue
        "500":
          description: Erreur serveur

  /api/app/refresh-token:
    post:
      tags: [App]
      summary: Rafraîchit un access token expiré via un refresh token valide
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                token:
                  type: string
                  description: Refresh token JWT
              required:
                - token
      responses:
        "200":
          description: Nouveau token généré
          content:
            application/json:
              schema:
                type: object
                properties:
                  accessToken:
                    type: string
        "401":
          description: Refresh token manquant
        "403":
          description: Refresh token invalide ou expiré
        "500":
          description: Erreur serveur

  ############################
  # ALERTES
  ############################
  /api/alerts:
    get:
      tags: [Alertes]
      summary: Récupère la liste des alertes citoyennes avec pagination
      parameters:
        - in: query
          name: page
          schema:
            type: integer
            minimum: 1
            default: 1
          description: Numéro de la page
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          description: Nombre d'alertes par page
      responses:
        "200":
          description: Liste paginée des alertes
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AlertePage"
        "500":
          description: Erreur interne du serveur

    post:
      tags: [Alertes]
      summary: Crée une nouvelle alerte citoyenne
      description: Nécessite le 'user_id' du créateur dans le corps de la requête.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AlerteInput"
      responses:
        "201":
          description: Alerte créée avec succès
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Alerte"
        "400":
          description: Données invalides

  /api/alerts/{id_alert}/{user_id}:
    get:
      tags: [Alertes]
      summary: Récupère une alerte par sa clé composite
      parameters:
        - name: id_alert
          in: path
          required: true
          description: ID de l'alerte
          schema:
            type: integer
        - name: user_id
          in: path
          required: true
          description: ID de l'utilisateur qui a créé l'alerte
          schema:
            type: integer
      responses:
        "200":
          description: Alerte trouvée
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Alerte"
        "404":
          description: Alerte non trouvée

    put:
      tags: [Alertes]
      summary: Met à jour une alerte existante
      parameters:
        - name: id_alert
          in: path
          required: true
          schema:
            type: integer
        - name: user_id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AlerteInput"
      responses:
        "200":
          description: Alerte mise à jour avec succès
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Alerte"
        "404":
          description: Alerte non trouvée

    delete:
      tags: [Alertes]
      summary: Supprime une alerte
      parameters:
        - name: id_alert
          in: path
          required: true
          schema:
            type: integer
        - name: user_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "204":
          description: Alerte supprimée avec succès
        "404":
          description: Alerte non trouvée

  ############################
  # CATEGORIES
  ############################

  /api/categories:
    get:
      tags: [Catégories]
      summary: Récupère toutes les catégories
      responses:
        "200":
          description: Liste des catégories récupérée avec succès
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Categorie"

    post:
      tags: [Catégories]
      summary: Crée une nouvelle catégorie
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CategorieInput"
      responses:
        "201":
          description: Catégorie créée avec succès
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Categorie"

  /api/categories/{id_category}:
    get:
      tags: [Catégories]
      summary: Récupère une catégorie par ID
      parameters:
        - name: id_category
          in: path
          required: true
          description: ID de la catégorie
          schema:
            type: integer
      responses:
        "200":
          description: Catégorie trouvée
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Categorie"
        "404":
          description: Catégorie non trouvée

    put:
      tags: [Catégories]
      summary: Met à jour une catégorie
      parameters:
        - name: id_category
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CategorieInput"
      responses:
        "200":
          description: Catégorie mise à jour
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Categorie"
        "404":
          description: Catégorie non trouvée

    delete:
      tags: [Catégories]
      summary: Supprime une catégorie
      parameters:
        - name: id_category
          in: path
          required: true
          schema:
            type: integer
      responses:
        "204":
          description: Catégorie supprimée
        "404":
          description: Catégorie non trouvée

  ############################
  # MEDIAS
  ############################

  /api/medias:
    get:
      tags: [ Médias ]
      summary: Récupère tous les médias
      responses:
        "200":
          description: Liste des médias
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Media"

    post:
      tags: [ Médias ]
      summary: Ajoute un média via une URL pré-uploadée
      description: Le client doit d'abord uploader le fichier sur un service externe puis fournir l'URL résultante.
      requestBody:
        required: true
        content:
          application/json: # CHANGEMENT: Le corps est JSON
            schema:
              $ref: "#/components/schemas/MediaInput"
      responses:
        "201":
          description: Média ajouté
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Media"

  /api/medias/{id_media}:
    get:
      tags: [Médias]
      summary: Récupère un média par ID
      parameters:
        - name: id_media
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: Média trouvé
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Media"
        "404":
          description: Média non trouvé

    delete:
      tags: [Médias]
      summary: Supprime un média
      parameters:
        - name: id_media
          in: path
          required: true
          schema:
            type: integer
      responses:
        "204":
          description: Média supprimé
        "404":
          description: Média non trouvé

  ############################
  # PARTICIPATIONS
  ############################

  /api/participations:
    get:
      tags: [Participations]
      summary: Liste toutes les participations
      responses:
        "200":
          description: Liste des participations
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Participation"

    post:
      tags: [Participations]
      summary: Crée une participation à une alerte
      description: Nécessite les IDs de l'utilisateur participant et de l'alerte ciblée (id_alert et alert_user_id).
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ParticipationInput"
      responses:
        "201":
          description: Participation créée
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Participation"

  /api/participations/{id_participation}:
    get:
      tags: [Participations]
      summary: Récupère une participation par ID
      parameters:
        - name: id_participation
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: Participation trouvée
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Participation"
        "404":
          description: Participation non trouvée

    delete:
      tags: [Participations]
      summary: Supprime une participation
      parameters:
        - name: id_participation
          in: path
          required: true
          schema:
            type: integer
      responses:
        "204":
          description: Participation supprimée
        "404":
          description: Participation non trouvée

  ############################
  # API KEYS
  ############################
  /api/api_keys:
    post:
      tags: [API Keys]
      summary: Crée une nouvelle clé API pour un utilisateur
      description: >
        Un utilisateur ne peut avoir qu'une seule clé API active.
        La clé brute (raw_key) est retournée uniquement lors de la création et ne pourra plus être récupérée par la suite.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ApiKeyInput"
      responses:
        "201":
          description: Clé API créée avec succès
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiKeyCreated"
        "400":
          description: Données invalides (user_id manquant)
        "409":
          description: L'utilisateur possède déjà une clé API
        "500":
          description: Erreur interne du serveur

  /api/api_keys/{user_id}:
    get:
      tags: [API Keys]
      summary: Récupère la clé API d'un utilisateur
      description: >
        Retourne les informations de la clé API (sans la clé brute).
        Retourne null si l'utilisateur n'a pas de clé.
      parameters:
        - name: user_id
          in: path
          required: true
          description: ID de l'utilisateur
          schema:
            type: integer
      responses:
        "200":
          description: Clé API trouvée ou null
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: "#/components/schemas/ApiKey"
                  - type: object
                    nullable: true
        "500":
          description: Erreur interne du serveur
    delete:
      tags: [API Keys]
      summary: Supprime la clé API d'un utilisateur
      parameters:
        - name: user_id
          in: path
          required: true
          description: ID de l'utilisateur
          schema:
            type: integer
      responses:
        "200":
          description: Clé API supprimée avec succès
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: API key deleted.
        "404":
          description: Aucune clé API trouvée pour cet utilisateur
        "500":
          description: Erreur interne du serveur

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    #######################
    # APP
    #######################
    App:
      type: object
      properties:
        id_api_key:
          type: integer
        user_id:
          type: integer
        key_hash:
          type: string
        name:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time
          nullable: true
        last_used_at:
          type: string
          format: date-time
          nullable: true
        expires_at:
          type: string
          format: date-time
          nullable: true
        is_active:
          type: boolean
          nullable: true
        refresh_token:
          type: string
          nullable: true
      required:
        - id_api_key
        - user_id
        - key_hash

    #######################
    # Alerte
    #######################
    Alerte:
      type: object
      properties:
        id_alert:
          type: integer
          description: Identifiant unique de l'alerte
        user_id:
          type: integer
          description: Identifiant de l'utilisateur qui a créé l'alerte (clé composite)
        title:
          type: string
          description: Titre de l'alerte
        description:
          type: string
          description: Description détaillée de l'alerte
        status:
          type: string
          description: Statut actuel de l'alerte
          enum: [ouverte, en_cours, resolue]
        intensity:
          type: string
          description: Niveau d'intensité ou d'urgence de l'alerte
        created_at:
          type: string
          format: date-time
          description: Date et heure de création de l'alerte
        location_lat:
          type: number
          format: double
          description: Latitude de la localisation de l'alerte
        location_lon:
          type: number
          format: double
          description: Longitude de la localisation de l'alerte
        id_category:
          type: integer
          description: Identifiant de la catégorie associée
        category:
          $ref: "#/components/schemas/Categorie"
        media:
          type: array
          items:
            $ref: "#/components/schemas/Media"
        participation:
          type: array
          items:
            $ref: "#/components/schemas/Participation"
      required:
        - id_alert
        - user_id
        - title
        - description
        - status
        - intensity
        - created_at
        - location_lat
        - location_lon
        - id_category

    AlerteInput:
      type: object
      properties:
        user_id:
          type: integer
          description: Identifiant de l'utilisateur créateur (clé composite nécessaire pour POST/PUT)
        title:
          type: string
          description: Titre de la nouvelle alerte
        description:
          type: string
          description: Description détaillée
        status:
          type: string
          description: Statut initial de l'alerte
          enum: [ouverte, en_cours, resolue]
          default: ouverte
        intensity:
          type: string
          description: Niveau d'intensité
        location_lat:
          type: number
          format: double
          description: Latitude de la localisation
        location_lon:
          type: number
          format: double
          description: Longitude de la localisation
        id_category:
          type: integer
          description: Identifiant de la catégorie
      required:
        - user_id
        - title
        - description
        - intensity
        - location_lat
        - location_lon
        - id_category

    AlertePage:
      type: object
      properties:
        page:
          type: integer
          description: Numéro de la page actuelle
        limit:
          type: integer
          description: Nombre d'éléments par page
        total_items:
          type: integer
          description: Nombre total d'alertes
        total_pages:
          type: integer
          description: Nombre total de pages
        items:
          type: array
          items:
            $ref: "#/components/schemas/Alerte"

    #######################
    # Catégorie
    #######################
    Categorie:
      type: object
      properties:
        id_category:
          type: integer
          description: Identifiant unique de la catégorie
        title:
          type: string
          description: Nom ou titre de la catégorie
      required:
        - id_category
        - title

    CategorieInput:
      type: object
      properties:
        title:
          type: string
          description: Nom ou titre de la catégorie
      required:
        - title

    #######################
    # Médias
    #######################
    Media:
      type: object
      properties:
        id_media:
          type: integer
          description: Identifiant unique du média
        file_type:
          type: string
          description: Type de fichier
        file_url:
          type: string
          format: uri
          description: URL du fichier média
        uploaded_at:
          type: string
          format: date-time
          description: Date et heure de l'upload
        id_alert:
          type: integer
          description: Identifiant de l'alerte associée (clé composite)
        user_id:
          type: integer
          description: Identifiant de l'utilisateur créateur de l'alerte associée (clé composite)
      required:
        - id_media
        - file_url
        - id_alert
        - user_id

    MediaInput:
      type: object
      properties:
        file_url:
          type: string
          format: uri
          description: URL publique du fichier média
        file_type:
          type: string
          description: Type du média
        id_alert:
          type: integer
          description: Identifiant de l'alerte à laquelle le média est associé
        user_id:
          type: integer
          description: Identifiant de l'utilisateur créateur de l'alerte (clé composite)
      required:
        - file_url
        - file_type
        - id_alert
        - user_id

    #######################
    # Participation
    #######################
    Participation:
      type: object
      properties:
        id_participation:
          type: integer
          description: Identifiant unique de la participation
        user_id:
          type: integer
          description: Identifiant de l'utilisateur qui participe
        response:
          type: string
          description: Message de la participation (réponse)
        date_response:
          type: string
          format: date-time
          description: Date et heure de la participation
        id_alert:
          type: integer
          description: Identifiant de l'alerte associée
        alert_user_id:
          type: integer
          description: Identifiant de l'utilisateur créateur de l'alerte associée (clé composite)
      required:
        - id_participation
        - user_id
        - date_response
        - id_alert
        - alert_user_id

    ParticipationInput:
      type: object
      properties:
        user_id:
          type: integer
          description: Identifiant de l'utilisateur qui participe
        response:
          type: string
          description: Message de la participation
        id_alert:
          type: integer
          description: Identifiant de l'alerte concernée
        alert_user_id:
          type: integer
          description: Identifiant de l'utilisateur créateur de l'alerte concernée
      required:
        - user_id
        - id_alert
        - alert_user_id

    #######################
    # API Key
    #######################
    ApiKey:
      type: object
      properties:
        id_api_key:
          type: integer
          description: Identifiant unique de la clé API
        user_id:
          type: integer
          description: Identifiant de l'utilisateur propriétaire de la clé
        name:
          type: string
          nullable: true
          maxLength: 100
          description: Nom optionnel pour identifier la clé
        created_at:
          type: string
          format: date-time
          description: Date et heure de création de la clé
        last_used_at:
          type: string
          format: date-time
          nullable: true
          description: Date et heure de dernière utilisation
        expires_at:
          type: string
          format: date-time
          nullable: true
          description: Date et heure d'expiration de la clé
        is_active:
          type: boolean
          description: Indique si la clé est active
      required:
        - id_api_key
        - user_id
        - created_at
        - is_active

    ApiKeyInput:
      type: object
      properties:
        user_id:
          type: integer
          description: Identifiant de l'utilisateur pour lequel créer la clé API
        name:
          type: string
          maxLength: 100
          description: Nom optionnel pour identifier la clé
      required:
        - user_id

    ApiKeyCreated:
      type: object
      properties:
        message:
          type: string
          example: API Key created.
        api_key:
          type: object
          properties:
            raw_key:
              type: string
              description: >
                Clé API brute (en clair). Cette valeur ne sera plus accessible après cette réponse.
                Le client doit la sauvegarder de manière sécurisée.
              example: "a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6"
            id_api_key:
              type: integer
              description: Identifiant unique de la clé API
            user_id:
              type: integer
              description: Identifiant de l'utilisateur
            name:
              type: string
              nullable: true
              description: Nom de la clé
            created_at:
              type: string
              format: date-time
              description: Date de création
            is_active:
              type: boolean
              description: Statut actif de la clé
      required:
        - message
        - api_key
